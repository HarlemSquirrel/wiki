!!! note "Not Yet Released"

    This version of Karafka has not yet been released.

# Upgrading to Karafka 2.4

!!! tip "Pro & Enterprise Upgrade Support"

    If you're gearing up to upgrade to the latest Karafka version and are a Pro or Enterprise user, remember you've got a dedicated lifeline! Reach out via the dedicated Slack channel for direct support to ensure everything has been covered.

As always, please make sure you have upgraded to the most recent version of `2.3` before upgrading to `2.4`.

Also, remember to read and apply our standard [upgrade procedures](https://karafka.io/docs/Upgrading/).

## Consumer Mapper Concept Removal

Karafka used to have a default strategy for building consumer group names. Each consumer group combined `client_id` and the group name taken from the routing.

Below, you can find how Karafka pre `2.4` would remap the following routing:

```ruby
class KarafkaApp < Karafka::App
  setup do |config|
    # ...
    config.client_id = 'my-app'
  end

  routes.draw do
    topic :example do
      consumer ExampleConsumer
    end

    topic :example2 do
      consumer Example2Consumer
    end

    consumer_group :special do
      topic :super_topic do
        consumer Example2Consumer
      end
    end
  end
end

Karafka::Web.enable!
```

The above setup would create three consumer groups:

<table>
  <tr>
    <th>Group Name</th>
    <th>Topics</th>
  </tr>
  <tr>
    <td>my-app_app</td>
    <td>example, example2</td>
  </tr>
  <tr>
    <td>my-app_special</td>
    <td>special</td>
  </tr>
  <tr>
    <td>my-app_karafka_web</td>
    <td>Web UI related topics</td>
  </tr>
</table>

While it was a good strategy, especially for multi-application and multi-tenant Kafka setups, this started to create many problems in places like the Pro Iterator, Admin, and in the case of the streaming capabilities I am working on. This also needed clarification for newcomers and people moving from other frameworks.

When working on `Karafka::Admin.read_lags`, it became clear that this would only create more problems when providing advanced consumer group capabilities. Hence, the decision was made to retire this functionality.

To upgrade to `2.4` you will have to align your consumer group naming as follows:

!!! Warning "Custom Mapper Naming Strategy Alignment"

    If you've used a custom mapper, align your naming to match the new setup according to your mapper behavior.

### Aligning the Simple Routing

When working without explicit consumer groups, all you need to do is alter the `group_id` setting to prefix it with the `client_id` value:

```ruby
class KarafkaApp < Karafka::App
  setup do |config|
    # ...
    config.client_id = 'my-app'
    # `app` without anything used to be the default name in the simple routing
    config.group_id = 'my-app_app'
  end

  # Simple routing is a routing without `consumer_group` bloks
  routes.draw do
    topic :topic1 do
      consumer EventsConsumer
    end

    topic :topic2 do
      consumer WebhooksConsumer
    end
  end
end
```

### Aligning the Multiple Consumer Groups Mode

In the case of the Multiple Consumer Group Mode, you need to update the `group_id` as well as the names of particular consumer groups:

```ruby
class KarafkaApp < Karafka::App
  setup do |config|
    # ...
    config.client_id = 'my-app'
    # `app` without anything used to be the default name in the simple routing
    config.group_id = 'my-app_app'
  end

  # Simple routing is a routing without `consumer_group` bloks
  routes.draw do
    # implicit group topics are covered with the `group_id` update
    topic :topic1 do
      consumer EventsConsumer
    end

    topic :topic2 do
      consumer WebhooksConsumer
    end

    # was: consumer_group do 'group_special' do
    consumer_group do 'my-app_group_special' do
      topic :topic3 do
        consumer SuperConsumer
      end
    end
  end
end
```

### Aligning the Admin

Reconfigure Admin to use the extended `group_id` during Karafka configuration:

```ruby
class KarafkaApp < Karafka::App
  setup do |config|
    # ...
    config.client_id = 'my-app'
    config.admin.group_id = 'my-app_karafka_admin'
  end

  routes.draw do
    # ...
  end
end
```

### Aligning the Web UI

Karafka Web UI injects its group, which the mapper also altered. To mitigate it, set the consumer group explicitly:

```ruby
# Put the below before enabling the Web UI

Karafka::Web.setup do |config|
  # Add the prefix matching your client_id merged with the underscore
  config.group_id = 'my-app_karafka_web'
end

Karafka::Web.enable!
```

### Aligning the CLI

Karafka CLI commands must be aligned, such as `bundle exec karafka server --exclude-consumer-groups group_name2,group_name3`.

Commands related to topics and subscription groups are not affected.

```bash
# Assuming that client_id is `my-app`

# Replace
bundle exec karafka server --exclude-consumer-groups group_name2,group_name3

# With
bundle exec karafka server --exclude-consumer-groups my-app_group_name2,my-app_group_name3
```
